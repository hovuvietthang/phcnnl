<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>REHABcloud | Số hoá HSBA</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tìm kiếm -->
    <div class="fixed top-0 w-full bg-white p-4 shadow z-10">
        <input 
            id="searchInput" 
            type="text" 
            placeholder="Tìm bệnh nhân..." 
            class="w-full max-w-xl mx-auto block p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
            oninput="filterTable()"
        />
    </div>

    <!-- Khoảng trống để tránh che bảng -->
    <div class="h-24"></div>

    <!-- Bảng dữ liệu -->
    <div class="container mx-auto p-4">
        <table class="min-w-full bg-white shadow rounded">
            <thead class="bg-blue-500 text-white">
                <tr>
                    <th class="p-2 text-left">Số HSBA</th>
                    <th class="p-2 text-left">Họ và tên</th>
                    <th class="p-2 text-left">Tuổi</th>
                    <th class="p-2 text-left">Giới tính</th>
                    <th class="p-2 text-left">Ngày vào viện</th>
                    <th class="p-2 text-left">Chẩn đoán</th>
                    <th class="p-2 text-left">Hồ sơ</th>
                </tr>
            </thead>
            <tbody id="resultTableBody"></tbody>
        </table>
        
        <!-- Phân trang -->
        <div class="flex justify-center mt-4">
            <button id="prevPage" class="p-2 px-4 bg-blue-500 text-white rounded-lg" onclick="changePage(-1)">Trước</button>
            <span id="pageNumber" class="mx-4">Trang 1</span>
            <button id="nextPage" class="p-2 px-4 bg-blue-500 text-white rounded-lg" onclick="changePage(1)">Sau</button>
        </div>

        <p id="noDataMessage" class="text-center text-gray-500 mt-4 hidden">Không có dữ liệu gần đây.</p>
    </div>

    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let allData = [];

        // Hàm fetch dữ liệu từ Google Sheets API
        async function fetchData() {
            const url = "https://script.googleusercontent.com/macros/echo?user_content_key=O1VPfuCtn-FC-jxeH1lmIfTIXz7xsJ39OWnmAVwMhhjFNVVJwOIPkXtf8E_9imUK94VbUuPYgMiGZzUQTkmeLQrCJX0bDdAlm5_BxDlH2jW0nuo2oDemN9CCS2h10ox_1xSncGQajx_ryfhECjZEnJdCvTcUUt53HQ1B32FemR_AdkJwwEvTcHQH5lerqyagMvvbYJaoV-p_5nSebKGafrIlE9RyJaVhd1A2oAUzsXcitcXpa6bG8w&lib=M6C_v2HTfHLlLRH0ki4RwMcTi32_F69pn"; 
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error("Không thể tải dữ liệu từ API.");
                }
                const data = await res.json();
                allData = data;

                // Hiển thị dữ liệu trang đầu tiên
                displayPage(currentPage);
            } catch (err) {
                console.error("Lỗi khi tải dữ liệu:", err);
                document.getElementById("noDataMessage").textContent = "Không thể tải dữ liệu, vui lòng thử lại sau.";
                document.getElementById("noDataMessage").classList.remove("hidden");
            }
        }

        // Hàm hiển thị trang theo số trang
        function displayPage(page) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = allData.slice(startIndex, endIndex);

            const tbody = document.getElementById("resultTableBody");
            tbody.innerHTML = "";

            if (pageData.length === 0) {
                document.getElementById("noDataMessage").classList.remove("hidden");
                return;
            }

            pageData.forEach(item => {
                const row = `
                    <tr class="border-b">
                        <td class="p-2">${item.sohsba || ""}</td>
                        <td class="p-2">${item.hovaten || ""}</td>
                        <td class="p-2">${item.tuoi || ""}</td>
                        <td class="p-2">${item.gioitinh || ""}</td>
                        <td class="p-2">${item.ngayvaovien || ""}</td>
                        <td class="p-2">${item.chandoan || ""}</td>
                        <td class="p-2">
                            <a href="${item.linkhoso}" target="_blank" class="text-blue-500 underline">Xem</a>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });

            document.getElementById("noDataMessage").classList.add("hidden");

            // Cập nhật số trang
            document.getElementById("pageNumber").textContent = `Trang ${page}`;
            document.getElementById("prevPage").disabled = page <= 1;
            document.getElementById("nextPage").disabled = page >= Math.ceil(allData.length / itemsPerPage);
        }

        // Hàm thay đổi trang
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= Math.ceil(allData.length / itemsPerPage)) {
                currentPage = newPage;
                displayPage(currentPage);
            }
        }

        // Hàm lọc bảng khi người dùng gõ vào ô tìm kiếm
        function filterTable() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("#resultTableBody tr");
            let found = false;

            rows.forEach(row => {
                const name = row.cells[1]?.textContent.toLowerCase() || "";
                const match = name.includes(input);
                row.style.display = match ? "" : "none";
                if (match) found = true;
            });

            document.getElementById("noDataMessage").classList.toggle("hidden", found);
        }

        // Tải dữ liệu khi trang web được tải
        window.onload = fetchData;
    </script>
</body>
</html>
